{% extends "base.html" %}

{% block title %}Books - Book Database{% endblock %}

{% block content %}
<header>
    <hgroup>
        <h1>{% if filter_status == 'unread' %}Unread {% elif filter_status == 'read' %}Read {% endif %}Books</h1>
        <p>{{ books.total }} book{{ 's' if books.total != 1 else '' }}{% if filter_status != 'all' %} matching filter{% endif %}</p>
    </hgroup>
    <div class="books-toolbar">
        <div class="dropdown-button">
            <a href="{{ url_for('book_new') }}" role="button" class="dropdown-main">Add New Book</a>
            <button type="button" class="dropdown-toggle" onclick="toggleDropdown(this)" aria-label="More options">â–¾</button>
            <ul class="dropdown-menu">
                <li><a href="#" onclick="promptImportUrl('amazon')">from Amazon URL</a></li>
                <li><a href="#" onclick="promptImportUrl('goodreads')">from GoodReads</a></li>
            </ul>
        </div>
        <div class="filter-tabs">
            <a href="{{ url_for('book_list', per_page=per_page, filter='all') }}" class="filter-btn{% if filter_status == 'all' %} active{% endif %}">All</a>
            <a href="{{ url_for('book_list', per_page=per_page, filter='unread') }}" class="filter-btn{% if filter_status == 'unread' %} active{% endif %}">Unread</a>
            <a href="{{ url_for('book_list', per_page=per_page, filter='read') }}" class="filter-btn{% if filter_status == 'read' %} active{% endif %}">Read</a>
        </div>
        <label class="per-page-label">
            <span>Per page:</span>
            <select id="per-page-select" onchange="changePerPage(this.value)">
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>
        </label>
    </div>
</header>

<!-- Import URL Modal -->
<dialog id="import-modal">
    <article>
        <header>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('import-modal').close()"></button>
            <h3 id="import-modal-title">Import Book</h3>
        </header>
        <form id="import-form" method="get">
            <label>
                Book URL
                <input type="url" name="url" id="import-url" placeholder="Paste the URL here..." required>
            </label>
        </form>
        <footer>
            <button class="secondary" onclick="document.getElementById('import-modal').close()">Cancel</button>
            <button onclick="submitImport()">Import</button>
        </footer>
    </article>
</dialog>

<script>
let currentSource = '';

function toggleDropdown(btn) {
    const menu = btn.nextElementSibling;
    menu.classList.toggle('show');
}

function promptImportUrl(source) {
    currentSource = source;
    const titles = {
        'amazon': 'Import from Amazon',
        'goodreads': 'Import from GoodReads'
    };
    document.getElementById('import-modal-title').textContent = titles[source];
    document.getElementById('import-url').value = '';
    document.getElementById('import-modal').showModal();
    // Close dropdown
    document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show'));
}

function submitImport() {
    const url = document.getElementById('import-url').value;
    if (url) {
        window.location.href = '{{ url_for("book_import") }}?source=' + currentSource + '&url=' + encodeURIComponent(url);
    }
}

// Close dropdown when clicking elsewhere
document.addEventListener('click', function(e) {
    if (!e.target.closest('.dropdown-button')) {
        document.querySelectorAll('.dropdown-menu.show').forEach(m => m.classList.remove('show'));
    }
});

// Per-page selection with localStorage
function changePerPage(value) {
    localStorage.setItem('books_per_page', value);
    const filter = '{{ filter_status }}';
    window.location.href = '{{ url_for("book_list") }}?per_page=' + value + '&filter=' + filter;
}

// On page load, check if we should redirect to stored preference
(function() {
    const storedPerPage = localStorage.getItem('books_per_page');
    const urlParams = new URLSearchParams(window.location.search);
    const currentPerPage = urlParams.get('per_page');
    const filter = urlParams.get('filter') || 'all';

    // If there's a stored preference and no per_page in URL, redirect
    if (storedPerPage && !currentPerPage && !urlParams.has('page')) {
        window.location.href = '{{ url_for("book_list") }}?per_page=' + storedPerPage + '&filter=' + filter;
    }
})();
</script>

{% if books.items %}
<div class="book-grid">
    {% for book in books.items %}
    <a href="{{ url_for('book_detail', id=book.id) }}" class="book-card" style="text-decoration: none; color: inherit;">
        {% if book.cover_image %}
        <img src="{{ url_for('static', filename='uploads/' + book.cover_image) }}" alt="{{ book.title }}">
        {% else %}
        <div class="placeholder-cover">ðŸ“š</div>
        {% endif %}
        <div class="book-card-content">
            <div class="book-card-title">{{ book.title }}</div>
            <div class="book-card-author">{{ book.author_names or 'Unknown Author' }}</div>
            {% if book.rating %}
            <div class="rating">
                {% for i in range(5) %}
                    {% if book.rating >= i + 1 %}â˜…{% elif book.rating >= i + 0.5 %}â˜…{% else %}â˜†{% endif %}
                {% endfor %}
                ({{ book.rating }})
            </div>
            {% endif %}
        </div>
    </a>
    {% endfor %}
</div>

{% if books.pages > 1 %}
<nav class="pagination">
    {% if books.has_prev %}
    <a href="{{ url_for('book_list', page=books.prev_num, per_page=per_page, filter=filter_status) }}">Previous</a>
    {% endif %}

    {% for page in books.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
        {% if page %}
            {% if page == books.page %}
            <span class="current">{{ page }}</span>
            {% else %}
            <a href="{{ url_for('book_list', page=page, per_page=per_page, filter=filter_status) }}">{{ page }}</a>
            {% endif %}
        {% else %}
        <span>...</span>
        {% endif %}
    {% endfor %}

    {% if books.has_next %}
    <a href="{{ url_for('book_list', page=books.next_num, per_page=per_page, filter=filter_status) }}">Next</a>
    {% endif %}
</nav>
{% endif %}

{% else %}
<article>
    {% if filter_status == 'unread' %}
    <p>No unread books found.</p>
    <a href="{{ url_for('book_list', per_page=per_page, filter='all') }}" role="button">View All Books</a>
    {% elif filter_status == 'read' %}
    <p>No read books found.</p>
    <a href="{{ url_for('book_list', per_page=per_page, filter='all') }}" role="button">View All Books</a>
    {% else %}
    <p>No books in your library yet.</p>
    <a href="{{ url_for('book_new') }}" role="button">Add Your First Book</a>
    {% endif %}
</article>
{% endif %}
{% endblock %}
