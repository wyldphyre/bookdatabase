{% extends "base.html" %}

{% block title %}{{ 'Edit' if book else 'Add' }} Book - Book Database{% endblock %}

{% block content %}
<h1>{{ 'Edit' if book else 'Add New' }} Book</h1>

<form method="post" enctype="multipart/form-data">
    <label>
        Title *
        <input type="text" name="title" value="{{ prefill.title if prefill else (book.title if book else '') }}" required>
    </label>

    <label>
        Subtitle
        <input type="text" name="subtitle" value="{{ book.subtitle or '' if book else '' }}">
    </label>

    {% if prefill and prefill.authors %}
    <article class="prefill-notice">
        <strong>Suggested authors from import:</strong>
        {% for author_name in prefill.authors %}
        <span class="author-suggestion">{{ author_name }}</span>
        {% endfor %}
        <br><small>Search for these authors below or add them as new authors.</small>
    </article>
    {% endif %}

    <fieldset>
        <legend>Authors</legend>

        <div id="selected-authors" class="selected-authors">
            {% if book %}
            {% for author in book.authors %}
            <span class="author-chip" data-author-id="{{ author.id }}">
                {{ author.name }}
                <input type="hidden" name="authors" value="{{ author.id }}">
                <button type="button" class="chip-remove" onclick="this.parentElement.remove()" aria-label="Remove">&times;</button>
            </span>
            {% endfor %}
            {% endif %}
        </div>

        <div class="author-picker">
            <input type="text"
                   id="author-search"
                   placeholder="Search for authors..."
                   autocomplete="off"
                   hx-get="{{ url_for('author_search') }}"
                   hx-trigger="input changed delay:200ms, focus"
                   hx-target="#author-search-results"
                   hx-vals='js:{exclude: Array.from(document.querySelectorAll("#selected-authors input[name=authors]")).map(i => i.value).join(",")}'
                   name="q">
            <div id="author-search-results"></div>
        </div>

        <details id="quick-add-author">
            <summary role="button" class="outline secondary">+ Add New Author</summary>
            <div style="margin-top: 1rem; padding: 1rem; background: var(--pico-card-background-color); border-radius: var(--pico-border-radius);">
                <label>
                    Author Name
                    <input type="text" name="name" id="new-author-name" placeholder="Enter author name...">
                </label>
                <button type="button" class="secondary"
                        hx-post="{{ url_for('author_quick_add') }}"
                        hx-include="#new-author-name"
                        hx-target="#selected-authors"
                        hx-swap="beforeend"
                        hx-on::after-request="document.getElementById('quick-add-author').removeAttribute('open'); document.getElementById('new-author-name').value = '';">
                    Add Author
                </button>
                <div id="quick-add-error"></div>
            </div>
        </details>
    </fieldset>

    <script>
    function addAuthor(id, name) {
        // Check if author already selected
        if (document.querySelector(`#selected-authors [data-author-id="${id}"]`)) {
            return;
        }

        const chip = document.createElement('span');
        chip.className = 'author-chip';
        chip.dataset.authorId = id;
        chip.innerHTML = `
            ${name}
            <input type="hidden" name="authors" value="${id}">
            <button type="button" class="chip-remove" onclick="this.parentElement.remove()" aria-label="Remove">&times;</button>
        `;

        document.getElementById('selected-authors').appendChild(chip);
        document.getElementById('author-search').value = '';
        document.getElementById('author-search-results').innerHTML = '';
    }

    function selectSeries(id, name) {
        const container = document.getElementById('selected-series');
        container.innerHTML = `
            <span class="series-chip" data-series-id="${id}">
                ${name}
                <input type="hidden" name="series_id" value="${id}">
                <button type="button" class="chip-remove" onclick="clearSeries()" aria-label="Remove">&times;</button>
            </span>
        `;
        document.getElementById('series-search').value = '';
        document.getElementById('series-search-results').innerHTML = '';
    }

    function clearSeries() {
        document.getElementById('selected-series').innerHTML = '';
    }

    function toggleNewTag() {
        const form = document.getElementById('quick-add-tag-form');
        form.hidden = !form.hidden;
        if (!form.hidden) document.getElementById('new-tag-name').focus();
    }

    function addTag(id, name) {
        if (document.querySelector(`#selected-tags [data-tag-id="${id}"]`)) {
            return;
        }

        const chip = document.createElement('span');
        chip.className = 'tag-chip';
        chip.dataset.tagId = id;
        chip.innerHTML = `
            ${name}
            <input type="hidden" name="tags" value="${id}">
            <button type="button" class="chip-remove" onclick="this.parentElement.remove()" aria-label="Remove">&times;</button>
        `;

        document.getElementById('selected-tags').appendChild(chip);
        document.getElementById('tag-search').value = '';
        document.getElementById('tag-search-results').innerHTML = '';
    }

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.author-picker')) {
            document.getElementById('author-search-results').innerHTML = '';
        }
        if (!e.target.closest('.series-picker')) {
            document.getElementById('series-search-results').innerHTML = '';
        }
        if (!e.target.closest('.tag-picker')) {
            document.getElementById('tag-search-results').innerHTML = '';
        }
    });
    </script>

    <div class="form-grid">
        <label>
            Format *
            <select name="format_id" required>
                <option value="">Select format...</option>
                {% for format in formats %}
                <option value="{{ format.id }}"
                        {% if book and book.format_id == format.id %}selected{% endif %}>
                    {{ format.name }}
                </option>
                {% endfor %}
            </select>
        </label>

        <label>
            Page Count
            <input type="number" name="page_count" value="{{ prefill.page_count if prefill and prefill.page_count else (book.page_count or '' if book else '') }}" min="0">
        </label>

        <label>
            Rating (0-5)
            <input type="number" name="rating" value="{{ book.rating or '' if book else '' }}" min="0" max="5" step="0.25">
        </label>
    </div>

    <fieldset>
        <legend>Series</legend>

        {% if prefill and prefill.series_name %}
        <article class="prefill-notice">
            <strong>Suggested series from import:</strong> {{ prefill.series_name }}
            <br><small>Search for this series below or create it.</small>
        </article>
        {% endif %}

        <div id="selected-series" class="selected-series">
            {% if book and book.series %}
            <span class="series-chip" data-series-id="{{ book.series.id }}">
                {{ book.series.name }}
                <input type="hidden" name="series_id" value="{{ book.series.id }}">
                <button type="button" class="chip-remove" onclick="clearSeries()" aria-label="Remove">&times;</button>
            </span>
            {% endif %}
        </div>

        <div class="series-picker">
            <input type="text"
                   id="series-search"
                   placeholder="Search for series..."
                   autocomplete="off"
                   hx-get="{{ url_for('series_search') }}"
                   hx-trigger="input changed delay:200ms, focus"
                   hx-target="#series-search-results"
                   hx-vals='js:{current: (document.querySelector("#selected-series input[name=series_id]") || {}).value || ""}'
                   name="q">
            <div id="series-search-results"></div>
        </div>

        <details id="quick-add-series">
            <summary role="button" class="outline secondary">+ Add New Series</summary>
            <div style="margin-top: 1rem; padding: 1rem; background: var(--pico-card-background-color); border-radius: var(--pico-border-radius);">
                <label>
                    Series Name
                    <input type="text" name="series_name" id="new-series-name" placeholder="Enter series name...">
                </label>
                <button type="button" class="secondary"
                        hx-post="{{ url_for('series_quick_add') }}"
                        hx-include="#new-series-name"
                        hx-target="#selected-series"
                        hx-swap="innerHTML"
                        hx-on::after-request="document.getElementById('quick-add-series').removeAttribute('open'); document.getElementById('new-series-name').value = '';">
                    Add Series
                </button>
            </div>
        </details>

        <label>
            Series Number
            <input type="number" name="series_number" value="{{ prefill.series_number if prefill and prefill.series_number else (book.series_number or '' if book else '') }}" step="0.1" min="0">
        </label>
    </fieldset>

    <div class="description-field">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <label for="description" style="margin: 0;">Description</label>
            <div class="fetch-buttons" style="display: flex; gap: 0.5rem;">
                <button type="button" class="outline secondary" onclick="fetchDescriptionFrom('amazon')" id="fetch-amazon-btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                    Fetch from Amazon
                </button>
                <button type="button" class="outline secondary" onclick="fetchDescriptionFrom('goodreads')" id="fetch-goodreads-btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                    Fetch from Goodreads
                </button>
            </div>
        </div>
        <textarea name="description" id="description" rows="4">{{ prefill.description if prefill and prefill.description else (book.description or '' if book else '') }}</textarea>
        <div id="fetch-description-error" style="color: var(--pico-del-color); margin-top: 0.5rem;"></div>
    </div>

    <script>
    async function fetchDescriptionFrom(source) {
        const title = document.querySelector('input[name="title"]').value.trim();
        const errorEl = document.getElementById('fetch-description-error');
        const btn = document.getElementById('fetch-' + source + '-btn');

        if (!title) {
            errorEl.textContent = 'Please enter a book title first';
            return;
        }

        // Get author names from selected authors
        const authorChips = document.querySelectorAll('#selected-authors .author-chip');
        const authorNames = Array.from(authorChips).map(chip => {
            // Get text content excluding the remove button
            const clone = chip.cloneNode(true);
            const button = clone.querySelector('button');
            if (button) button.remove();
            const input = clone.querySelector('input');
            if (input) input.remove();
            return clone.textContent.trim();
        }).join(', ');

        errorEl.textContent = '';
        btn.setAttribute('aria-busy', 'true');
        btn.disabled = true;

        try {
            const params = new URLSearchParams({
                title: title,
                author: authorNames,
                source: source
            });
            const response = await fetch('{{ url_for("search_description") }}?' + params);
            const data = await response.json();

            if (response.ok && data.description) {
                document.getElementById('description').value = data.description;
                errorEl.textContent = '';
            } else {
                errorEl.textContent = data.error || 'Failed to fetch description';
            }
        } catch (e) {
            errorEl.textContent = 'Network error: ' + e.message;
        } finally {
            btn.removeAttribute('aria-busy');
            btn.disabled = false;
        }
    }
    </script>

    <fieldset>
        <legend>Cover Image</legend>
        {% if book and book.cover_image %}
        <p><small>Current: {{ book.cover_image }}</small></p>
        {% endif %}
        <label>
            Upload file
            <input type="file" name="cover_image" accept="image/*">
        </label>
        <label>
            Or provide URL
            <input type="url" name="cover_image_url" placeholder="https://example.com/cover.jpg" value="{{ prefill.cover_url if prefill and prefill.cover_url else '' }}">
        </label>
    </fieldset>

    <div class="form-grid">
        <label>
            Date Purchased
            <input type="date" name="date_purchased" value="{{ book.date_purchased.strftime('%Y-%m-%d') if book and book.date_purchased else '' }}">
        </label>

        <label>
            Cost
            <input type="number" name="cost" value="{{ book.cost or '' if book else '' }}" step="0.01" min="0">
        </label>

        <label>
            Discounts
            <input type="number" name="discounts" value="{{ book.discounts or '' if book else '' }}" step="0.01" min="0">
        </label>

        <label>
            Paid
            <input type="number" name="paid" value="{{ book.paid or '' if book else '' }}" step="0.01" min="0">
        </label>
    </div>

    <fieldset>
        <label>
            <input type="checkbox" name="is_book_bundle" {% if book and book.is_book_bundle %}checked{% endif %}>
            This is a book bundle
        </label>
    </fieldset>

    <label>
        Bundled Books (e.g., "1-3, 1-10")
        <input type="text" name="bundled_books" value="{{ book.bundled_books or '' if book else '' }}">
    </label>

    <label>
        Notes/Comments
        <textarea name="comment" rows="3">{{ book.comment or '' if book else '' }}</textarea>
    </label>

    <fieldset>
        <legend>Tags</legend>

        <div id="selected-tags" class="selected-tags">
            {% if book %}
            {% for tag in book.tags %}
            <span class="tag-chip" data-tag-id="{{ tag.id }}">
                {{ tag.name }}
                <input type="hidden" name="tags" value="{{ tag.id }}">
                <button type="button" class="chip-remove" onclick="this.parentElement.remove()" aria-label="Remove">&times;</button>
            </span>
            {% endfor %}
            {% endif %}
        </div>

        <div class="tag-picker">
            <div class="tag-picker-row">
                <input type="text"
                       id="tag-search"
                       placeholder="Search for tags..."
                       autocomplete="off"
                       hx-get="{{ url_for('tag_search') }}"
                       hx-trigger="input changed delay:200ms, focus"
                       hx-target="#tag-search-results"
                       hx-vals='js:{exclude: Array.from(document.querySelectorAll("#selected-tags input[name=tags]")).map(i => i.value).join(",")}'
                       name="q">
                <button type="button" class="outline secondary tag-new-btn" onclick="toggleNewTag()">+ New</button>
            </div>
            <div id="tag-search-results"></div>
        </div>

        <div id="quick-add-tag-form" hidden class="quick-add-tag-form">
            <input type="text" name="tag_name" id="new-tag-name" placeholder="New tag name...">
            <button type="button" class="secondary tag-new-btn"
                    hx-post="{{ url_for('tag_quick_add') }}"
                    hx-include="#new-tag-name"
                    hx-target="#selected-tags"
                    hx-swap="beforeend"
                    hx-on::after-request="document.getElementById('quick-add-tag-form').hidden = true; document.getElementById('new-tag-name').value = '';">
                Add
            </button>
        </div>
    </fieldset>

    <div class="button-group">
        <button type="submit">{{ 'Update' if book else 'Add' }} Book</button>
        <a href="{{ url_for('book_detail', id=book.id) if book else url_for('book_list') }}" role="button" class="secondary">Cancel</a>
    </div>
</form>
{% endblock %}
