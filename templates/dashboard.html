{% extends "base.html" %}

{% block title %}Dashboard - Book Database{% endblock %}

{% block content %}
<h1>Dashboard</h1>

<div class="stats">
    <div class="stat">
        <div class="stat-value">{{ total_books }}</div>
        <div class="stat-label">Total Books</div>
    </div>
    <div class="stat">
        <div class="stat-value">{{ total_reads }}</div>
        <div class="stat-label">Completed Reads</div>
    </div>
    <div class="stat">
        <div class="stat-value">{{ active_reads|length }}</div>
        <div class="stat-label">Currently Reading</div>
    </div>
</div>

<h2>Currently Reading</h2>

{% if active_reads %}
<div class="active-reads-scroll">
    {% for read in active_reads %}
    <div class="active-read-card">
        <a href="{{ url_for('book_detail', id=read.book.id) }}" class="active-read-cover-link">
            {% if read.book.cover_image %}
            <img src="{{ url_for('static', filename='uploads/' + read.book.cover_image) }}" alt="{{ read.book.title }}" loading="lazy">
            {% else %}
            <div class="active-read-placeholder">ðŸ“š</div>
            {% endif %}
        </a>
        <div class="active-read-info">
            <h3><a href="{{ url_for('book_detail', id=read.book.id) }}">{{ read.book.title }}</a></h3>
            {% if read.book.authors %}
            <p class="active-read-authors">
                {% for author in read.book.authors %}
                <a href="{{ url_for('author_detail', id=author.id) }}">{{ author.name }}</a>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </p>
            {% endif %}
            {% if read.book.series %}
            <p class="active-read-series">
                <a href="{{ url_for('series_detail', id=read.book.series.id) }}">{{ read.book.series.name }}</a>{% if read.book.series_number %} #{{ read.book.series_number|num }}{% endif %}
            </p>
            {% endif %}
            {% if read.start_date %}
            {% set days = read.start_date|days_since %}
            <p class="active-read-meta">Started {{ read.start_date.strftime('%b %d, %Y') }} &middot; {{ days }} {{ 'day' if days == 1 else 'days' }}</p>
            {% endif %}
            {% if read.book.page_count %}
            <p class="active-read-meta">{{ read.book.page_count }} pages</p>
            {% endif %}
        </div>
        <div class="active-read-actions">
            <form method="post" action="{{ url_for('read_complete', id=read.id) }}">
                <button type="submit" class="outline small">Mark Complete</button>
            </form>
            <form method="post" action="{{ url_for('read_abandon', id=read.id) }}"
                  onsubmit="return confirm('Abandon reading {{ read.book.title|e }}?');">
                <button type="submit" class="outline secondary small">Abandon</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
    <article>
        <p>You're not currently reading any books.</p>
        <a href="{{ url_for('book_list') }}" role="button">Browse Books</a>
    </article>
{% endif %}

<h2>Recently Added</h2>
{% if recently_added %}
<div class="recently-added-scroll">
    {% for book in recently_added %}
    <a href="{{ url_for('book_detail', id=book.id) }}" class="recently-added-card">
        {% set is_read = book.reads|selectattr('status', 'equalto', 'Completed')|list|length > 0 %}
        <div class="cover-wrapper">
            {% if book.cover_image %}
            <img src="{{ url_for('static', filename='uploads/' + book.cover_image) }}" alt="{{ book.title }}" loading="lazy">
            {% else %}
            <div class="recently-added-placeholder">{{ book.title[0] }}</div>
            {% endif %}
            {% if is_read %}<img src="{{ url_for('static', filename='img/read-overlay.svg') }}" class="read-overlay" alt="Read">{% endif %}
        </div>
        <div class="recently-added-info">
            <strong>{{ book.title }}</strong>
            {% if book.authors %}
            <small>{% for author in book.authors %}{{ author.name }}{% if not loop.last %}, {% endif %}{% endfor %}</small>
            {% endif %}
        </div>
    </a>
    {% endfor %}
</div>
{% endif %}
{% endblock %}
