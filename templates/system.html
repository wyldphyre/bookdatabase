{% extends "base.html" %}

{% block title %}System - Book Database{% endblock %}

{% block content %}
<h1>System</h1>
<p class="secondary">Book Database v{{ version }}</p>

<article>
    <h3>Appearance</h3>
    <div style="display: flex; align-items: center; gap: 1rem;">
        <span>Theme:</span>
        <button id="theme-toggle" class="outline" style="margin: 0; width: auto;" onclick="toggleTheme()">
        </button>
    </div>
    <script>
    function updateThemeButton() {
        var current = document.documentElement.getAttribute('data-theme') || 'light';
        document.getElementById('theme-toggle').textContent = current === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
    }
    function toggleTheme() {
        var current = document.documentElement.getAttribute('data-theme') || 'light';
        var next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        updateThemeButton();
    }
    updateThemeButton();
    </script>
</article>

<article>
    <h3>Tag Management</h3>
    <p>Search, rename, or delete tags across your library.</p>

    <input type="search"
           id="system-tag-search"
           name="q"
           placeholder="Search tags by name..."
           autocomplete="off"
           hx-get="{{ url_for('system_tag_search') }}"
           hx-trigger="input changed delay:200ms"
           hx-target="#system-tag-results">

    <div id="system-tag-results"></div>
</article>

<article>
    <h3>Series Book Count Scanner</h3>
    <p>Scan Goodreads and Amazon to update the number of books in each series. Only series with external links will be scanned.</p>

    <div id="series-scan-area">
        {% include "system/_series_scan_progress.html" %}
    </div>
</article>

<article>
    <h3>Goodreads Genre Scanner</h3>
    <p>Scan Goodreads for each book in your library and import genres as tags. Existing tags will be reused.</p>

    <div id="scan-area">
        {% include "system/_scan_progress.html" %}
    </div>
</article>

<script>
function startRename(tagId) {
    document.getElementById('tag-name-' + tagId).hidden = true;
    document.getElementById('tag-rename-form-' + tagId).hidden = false;
    document.querySelector('#tag-rename-form-' + tagId + ' input[name="name"]').focus();
}

function cancelRename(tagId) {
    document.getElementById('tag-name-' + tagId).hidden = false;
    document.getElementById('tag-rename-form-' + tagId).hidden = true;
}

// Preserve scan log scroll position across htmx polling swaps
document.addEventListener('htmx:beforeSwap', function(e) {
    if (e.detail.target.id === 'scan-area') {
        var logEl = document.querySelector('#scan-area .scan-log-entries');
        if (logEl) window._scanLogScroll = logEl.scrollTop;
    }
    if (e.detail.target.id === 'series-scan-area') {
        var logEl = document.querySelector('#series-scan-area .scan-log-entries');
        if (logEl) window._seriesScanLogScroll = logEl.scrollTop;
    }
});
document.addEventListener('htmx:afterSettle', function(e) {
    if (e.detail.target.id === 'scan-area') {
        var logEl = document.querySelector('#scan-area .scan-log-entries');
        if (logEl && window._scanLogScroll !== undefined) {
            logEl.scrollTop = window._scanLogScroll;
        }
    }
    if (e.detail.target.id === 'series-scan-area') {
        var logEl = document.querySelector('#series-scan-area .scan-log-entries');
        if (logEl && window._seriesScanLogScroll !== undefined) {
            logEl.scrollTop = window._seriesScanLogScroll;
        }
    }
});
</script>
{% endblock %}
