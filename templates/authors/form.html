{% extends "base.html" %}

{% block title %}{{ 'Edit' if author else 'Add' }} Author - Book Database{% endblock %}

{% block content %}
<h1>{{ 'Edit' if author else 'Add New' }} Author</h1>

<form method="post">
    <label>
        Name *
        <input type="text" name="name" value="{{ author.name if author else '' }}" required>
    </label>

    <div class="form-grid">
        <label>
            Pronouns
            <input type="text" name="pronouns" value="{{ author.pronouns or '' if author else '' }}" placeholder="e.g., she/her, he/him, they/them">
        </label>

        <label>
            Gender
            <select name="gender_id">
                <option value="">Unknown</option>
                {% for gender in genders %}
                <option value="{{ gender.id }}"
                        {% if author and author.gender_id == gender.id %}selected{% endif %}>
                    {{ gender.name }}
                </option>
                {% endfor %}
            </select>
        </label>
    </div>

    <label>
        Alias Of
        <input type="text" id="alias-of-input" list="alias-of-options" autocomplete="off"
               placeholder="Search for an author..."
               value="{% if author and author.alias_of %}{{ author.alias_of.name }}{% endif %}">
        <input type="hidden" name="alias_of_id" id="alias-of-id"
               value="{{ author.alias_of_id or '' if author else '' }}">
        <datalist id="alias-of-options">
            {% for other_author in authors %}
            <option value="{{ other_author.name }}" data-id="{{ other_author.id }}"></option>
            {% endfor %}
        </datalist>
        <small>If this is a pen name or alternate name for another author</small>
    </label>

    <script>
    (function() {
        const input = document.getElementById('alias-of-input');
        const hidden = document.getElementById('alias-of-id');
        const options = document.querySelectorAll('#alias-of-options option');
        const nameToId = {};
        options.forEach(opt => { nameToId[opt.value] = opt.dataset.id; });

        input.addEventListener('input', function() {
            if (nameToId[this.value]) {
                hidden.value = nameToId[this.value];
            } else if (this.value === '') {
                hidden.value = '';
            }
        });
        input.addEventListener('change', function() {
            if (!nameToId[this.value] && this.value !== '') {
                this.value = '';
                hidden.value = '';
            }
        });
    })();
    </script>

    <details>
        <summary>External Links</summary>
        <div class="form-grid">
            <label>
                Goodreads URL
                <input type="url" name="goodreads_url" value="{{ author.goodreads_url or '' if author else '' }}" placeholder="https://goodreads.com/author/...">
            </label>
            <label>
                Amazon URL
                <input type="url" name="amazon_url" value="{{ author.amazon_url or '' if author else '' }}" placeholder="https://amazon.com/...">
            </label>
        </div>
        <div class="form-grid">
            <label>
                StoryGraph URL
                <input type="url" name="storygraph_url" value="{{ author.storygraph_url or '' if author else '' }}" placeholder="https://app.thestorygraph.com/authors/...">
            </label>
            <label>
                Website
                <input type="url" name="website" value="{{ author.website or '' if author else '' }}" placeholder="https://...">
            </label>
        </div>
    </details>

    <fieldset>
        <legend>Tags</legend>

        <div id="selected-tags" class="selected-tags">
            {% if author %}
            {% for tag in author.tags %}
            <span class="tag-chip" data-tag-id="{{ tag.id }}">
                {{ tag.name }}
                <input type="hidden" name="tags" value="{{ tag.id }}">
                <button type="button" class="chip-remove" onclick="this.parentElement.remove()" aria-label="Remove">&times;</button>
            </span>
            {% endfor %}
            {% endif %}
        </div>

        <div class="tag-picker">
            <div class="tag-picker-row">
                <input type="text"
                       id="tag-search"
                       placeholder="Search for tags..."
                       autocomplete="off"
                       hx-get="{{ url_for('tag_search') }}"
                       hx-trigger="input changed delay:200ms, focus"
                       hx-target="#tag-search-results"
                       hx-vals='js:{exclude: Array.from(document.querySelectorAll("#selected-tags input[name=tags]")).map(i => i.value).join(",")}'
                       name="q">
                <button type="button" class="outline secondary tag-new-btn" onclick="toggleNewTag()">+ New</button>
            </div>
            <div id="tag-search-results"></div>
        </div>

        <div id="quick-add-tag-form" hidden class="quick-add-tag-form">
            <input type="text" name="tag_name" id="new-tag-name" placeholder="New tag name...">
            <button type="button" class="secondary tag-new-btn"
                    hx-post="{{ url_for('tag_quick_add') }}"
                    hx-include="#new-tag-name"
                    hx-target="#selected-tags"
                    hx-swap="beforeend"
                    hx-on::after-request="document.getElementById('quick-add-tag-form').hidden = true; document.getElementById('new-tag-name').value = '';">
                Add
            </button>
        </div>
    </fieldset>

    <script>
    function toggleNewTag() {
        const form = document.getElementById('quick-add-tag-form');
        form.hidden = !form.hidden;
        if (!form.hidden) document.getElementById('new-tag-name').focus();
    }

    function addTag(id, name) {
        if (document.querySelector(`#selected-tags [data-tag-id="${id}"]`)) {
            return;
        }

        const chip = document.createElement('span');
        chip.className = 'tag-chip';
        chip.dataset.tagId = id;
        chip.innerHTML = `
            ${name}
            <input type="hidden" name="tags" value="${id}">
            <button type="button" class="chip-remove" onclick="this.parentElement.remove()" aria-label="Remove">&times;</button>
        `;

        document.getElementById('selected-tags').appendChild(chip);
        document.getElementById('tag-search').value = '';
        document.getElementById('tag-search-results').innerHTML = '';
    }

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.tag-picker')) {
            document.getElementById('tag-search-results').innerHTML = '';
        }
    });
    </script>

    <div class="button-group">
        <button type="submit">{{ 'Update' if author else 'Add' }} Author</button>
        <a href="{{ url_for('author_detail', id=author.id) if author else url_for('author_list') }}" role="button" class="secondary">Cancel</a>
    </div>
</form>
{% endblock %}
