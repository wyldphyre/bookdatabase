{% extends "base.html" %}

{% block title %}Series - Book Database{% endblock %}

{% block content %}
<header>
    <hgroup>
        <h1>Series</h1>
        <p>{{ series_list.total }} series{% if search %} matching "{{ search }}"{% endif %}{% if filter_type != 'all' %} (filtered){% endif %}</p>
    </hgroup>
    <div class="books-toolbar">
        <a href="{{ url_for('series_new') }}" role="button">Add New Series</a>
        <div class="filter-tabs">
            <a href="{{ url_for('series_list', per_page=per_page, search=search, filter='all') }}" class="filter-btn{% if filter_type == 'all' %} active{% endif %}">All</a>
            <a href="{{ url_for('series_list', per_page=per_page, search=search, filter='no_links') }}" class="filter-btn{% if filter_type == 'no_links' %} active{% endif %}">No Links</a>
            <a href="{{ url_for('series_list', per_page=per_page, search=search, filter='incomplete') }}" class="filter-btn{% if filter_type == 'incomplete' %} active{% endif %}">Incomplete</a>
            <a href="{{ url_for('series_list', per_page=per_page, search=search, filter='complete') }}" class="filter-btn{% if filter_type == 'complete' %} active{% endif %}">Complete</a>
        </div>
        <label class="per-page-label">
            <span>Per page:</span>
            <select id="per-page-select" onchange="changePerPage(this.value)">
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>
        </label>
    </div>
</header>

<div style="margin-top: 1rem;"></div>

<form action="{{ url_for('series_list') }}" method="get">
    {% if filter_type != 'all' %}<input type="hidden" name="filter" value="{{ filter_type }}">{% endif %}
    <input type="search" name="search" id="series-list-search" placeholder="Search series..." value="{{ search }}"
           hx-get="{{ url_for('series_list', filter=filter_type) }}"
           hx-trigger="keyup changed delay:300ms"
           hx-target="#series-results"
           hx-select="#series-results"
           hx-push-url="true">
</form>

<div id="series-results">

{% if series_list.items %}
    <div class="series-grid">
        {% for series in series_list.items %}
        <div class="series-card">
            <div class="series-info">
                <a href="{{ url_for('series_detail', id=series.id) }}"><strong>{{ series.name }}</strong></a>
                {% if series.number_in_series %}
                <br><small class="secondary">{{ series.number_in_series }} books in series</small>
                {% endif %}
                <br><small>{{ series.books|length }} book{{ 's' if series.books|length != 1 else '' }} in library</small>
                {% if series.books %}
                <div class="series-covers">
                    {% for book in series.books|sort_by('series_number') %}
                    {% if loop.index <= 5 %}
                    <a href="{{ url_for('book_detail', id=book.id) }}" class="series-cover-link" title="{{ book.title }}{% if book.series_number %} (#{{ book.series_number|num }}){% endif %}">
                        {% if book.cover_image %}
                        <img src="{{ url_for('static', filename='uploads/' + book.cover_image) }}" alt="{{ book.title }}" loading="lazy">
                        {% else %}
                        <div class="series-cover-placeholder">{{ book.title[0] }}</div>
                        {% endif %}
                    </a>
                    {% endif %}
                    {% endfor %}
                    {% if series.books|length > 5 %}
                    <span class="series-more">+{{ series.books|length - 5 }}</span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="button-group">
                <a href="{{ url_for('series_edit', id=series.id) }}" role="button" class="outline secondary small">Edit</a>
            </div>
        </div>
        {% endfor %}
    </div>

{% if series_list.pages > 1 %}
<nav class="pagination">
    {% if series_list.has_prev %}
    <a href="{{ url_for('series_list', page=series_list.prev_num, per_page=per_page, search=search, filter=filter_type) }}">Previous</a>
    {% endif %}

    {% for page in series_list.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
        {% if page %}
            {% if page == series_list.page %}
            <span class="current">{{ page }}</span>
            {% else %}
            <a href="{{ url_for('series_list', page=page, per_page=per_page, search=search, filter=filter_type) }}">{{ page }}</a>
            {% endif %}
        {% else %}
        <span>...</span>
        {% endif %}
    {% endfor %}

    {% if series_list.has_next %}
    <a href="{{ url_for('series_list', page=series_list.next_num, per_page=per_page, search=search, filter=filter_type) }}">Next</a>
    {% endif %}
</nav>
{% endif %}

{% else %}
    <article>
        {% if filter_type == 'no_links' %}
        <p>All series have external links.</p>
        <a href="{{ url_for('series_list', per_page=per_page, filter='all') }}" role="button">View All Series</a>
        {% elif filter_type == 'incomplete' %}
        <p>All series are complete. Nice work!</p>
        <a href="{{ url_for('series_list', per_page=per_page, filter='all') }}" role="button">View All Series</a>
        {% elif filter_type == 'complete' %}
        <p>No series are fully complete yet. Keep reading!</p>
        <a href="{{ url_for('series_list', per_page=per_page, filter='all') }}" role="button">View All Series</a>
        {% elif search %}
        <p>No series found matching "{{ search }}".</p>
        {% else %}
        <p>No series yet.</p>
        <a href="{{ url_for('series_new') }}" role="button">Add Your First Series</a>
        {% endif %}
    </article>
{% endif %}
</div>

<script>
function changePerPage(value) {
    localStorage.setItem('series_per_page', value);
    var filter = '{{ filter_type }}';
    var search = '{{ search }}';
    var url = '{{ url_for("series_list") }}?per_page=' + value + '&filter=' + filter;
    if (search) url += '&search=' + encodeURIComponent(search);
    window.location.href = url;
}

(function() {
    var storedPerPage = localStorage.getItem('series_per_page');
    var urlParams = new URLSearchParams(window.location.search);
    var currentPerPage = urlParams.get('per_page');

    if (storedPerPage && !currentPerPage && !urlParams.has('page')) {
        var filter = urlParams.get('filter') || 'all';
        var search = urlParams.get('search') || '';
        var url = '{{ url_for("series_list") }}?per_page=' + storedPerPage + '&filter=' + filter;
        if (search) url += '&search=' + encodeURIComponent(search);
        window.location.href = url;
    }
})();
</script>
{% endblock %}
