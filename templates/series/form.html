{% extends "base.html" %}

{% block title %}{{ 'Edit' if series else 'Add' }} Series - Book Database{% endblock %}

{% block content %}
<h1>{{ 'Edit' if series else 'Add New' }} Series</h1>

<form method="post">
    <label>
        Name *
        <input type="text" name="name" value="{{ series.name if series else '' }}" required>
    </label>

    <label>
        Number of Books in Series
        <input type="number" name="number_in_series" value="{{ series.number_in_series or '' if series else '' }}" min="0">
        <small>Optional: Total number of books in the complete series</small>
    </label>

    <details>
        <summary>External Links</summary>
        <div class="form-grid">
            <label>
                Goodreads URL
                <input type="url" name="goodreads_url" value="{{ series.goodreads_url or '' if series else '' }}" placeholder="https://goodreads.com/series/...">
            </label>
            <label>
                Amazon URL
                <input type="url" name="amazon_url" value="{{ series.amazon_url or '' if series else '' }}" placeholder="https://amazon.com/...">
            </label>
        </div>
        <label>
            StoryGraph URL
            <input type="url" name="storygraph_url" value="{{ series.storygraph_url or '' if series else '' }}" placeholder="https://app.thestorygraph.com/...">
        </label>
    </details>

    <fieldset>
        <legend>Tags</legend>

        <div id="selected-tags" class="selected-tags">
            {% if series %}
            {% for tag in series.tags %}
            <span class="tag-chip" data-tag-id="{{ tag.id }}">
                {{ tag.name }}
                <input type="hidden" name="tags" value="{{ tag.id }}">
                <button type="button" class="chip-remove" onclick="this.parentElement.remove()" aria-label="Remove">&times;</button>
            </span>
            {% endfor %}
            {% endif %}
        </div>

        <div class="tag-picker">
            <div class="tag-picker-row">
                <input type="text"
                       id="tag-search"
                       placeholder="Search for tags..."
                       autocomplete="off"
                       hx-get="{{ url_for('tag_search') }}"
                       hx-trigger="input changed delay:200ms, focus"
                       hx-target="#tag-search-results"
                       hx-vals='js:{exclude: Array.from(document.querySelectorAll("#selected-tags input[name=tags]")).map(i => i.value).join(",")}'
                       name="q">
                <button type="button" class="outline secondary tag-new-btn" onclick="toggleNewTag()">+ New</button>
            </div>
            <div id="tag-search-results"></div>
        </div>

        <div id="quick-add-tag-form" hidden class="quick-add-tag-form">
            <input type="text" name="tag_name" id="new-tag-name" placeholder="New tag name...">
            <button type="button" class="secondary tag-new-btn"
                    hx-post="{{ url_for('tag_quick_add') }}"
                    hx-include="#new-tag-name"
                    hx-target="#selected-tags"
                    hx-swap="beforeend"
                    hx-on::after-request="document.getElementById('quick-add-tag-form').hidden = true; document.getElementById('new-tag-name').value = '';">
                Add
            </button>
        </div>
    </fieldset>

    <script>
    function toggleNewTag() {
        const form = document.getElementById('quick-add-tag-form');
        form.hidden = !form.hidden;
        if (!form.hidden) document.getElementById('new-tag-name').focus();
    }

    function addTag(id, name) {
        if (document.querySelector(`#selected-tags [data-tag-id="${id}"]`)) {
            return;
        }

        const chip = document.createElement('span');
        chip.className = 'tag-chip';
        chip.dataset.tagId = id;
        chip.innerHTML = `
            ${name}
            <input type="hidden" name="tags" value="${id}">
            <button type="button" class="chip-remove" onclick="this.parentElement.remove()" aria-label="Remove">&times;</button>
        `;

        document.getElementById('selected-tags').appendChild(chip);
        document.getElementById('tag-search').value = '';
        document.getElementById('tag-search-results').innerHTML = '';
    }

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.tag-picker')) {
            document.getElementById('tag-search-results').innerHTML = '';
        }
    });
    </script>

    <div class="button-group">
        <button type="submit">{{ 'Update' if series else 'Add' }} Series</button>
        <a href="{{ url_for('series_detail', id=series.id) if series else url_for('series_list') }}" role="button" class="secondary">Cancel</a>
    </div>
</form>
{% endblock %}
